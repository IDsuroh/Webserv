# webserv.conf
# Full Configuration file covering:
# - basic static site
# - autoindex
# - upload (POST)
# - delete (DELETE)
# - CGI
# - stress-test endpoints

server  {
    # --------------------- Basic Server Info --------------------------
    listen      127.0.0.1:8080;
    server_name localhost;

    root        ./www;
    index       index.html;

    client_max_body_size    5M;

    error_page  400 ./errors/400.html;
    error_page  403 ./errors/403.html;
    error_page  404 ./errors/404.html;
    error_page  405 ./errors/405.html;
    error_page  413 ./errors/413.html;
    error_page  431 ./errors/431.html;
    error_page  500 ./errors/500.html;
    error_page  501 ./errors/501.html;
    error_page  502 ./errors/502.html;
    error_page  503 ./errors/503.html;
    error_page  504 ./errors/504.html;
    error_page  505 ./errors/505.html;

    # ========== NORMAL WEBSITE PART ==========

    # Root location
    # GET / -> ./www/index.html
    location /  {
        methods     GET;
        autoindex   off;
    }

    # Static resources (CSS, images, JS, etc.)
    # GET /static/style.css -> ./www/static/style.css
    location /static    {
        methods     GET;
        autoindex   on;
    }

    # Directory listing test
    # GET /files/ -> list contents of ./www/files/
    location /files {
        methods     GET;
        autoindex   on;
    }

    # ========== UPLOAD / POST TESTS ==========

    location /upload {
        methods     GET POST;
        autoindex   on;
        upload_store ./www/upload;   # make sure ./www/upload exists and is writable
    }

    # ========== DELETE TESTS ==========

    # Delete-only area
    # - GET     /trash/         -> list ./www/trash/ (autoindex)
    # - DELETE  /trash/foo.txt  -> remove ./www/trash/foo.txt
    location /trash {
        methods     GET DELETE;
        autoindex   on;
    }

    # Read-only endpoint to trigger 405 Method Not Allowed
    # - GET     /stress/readonly    -> OK (serve a file or 200 response)
    # - POST    /stress/readonly    -> 405
    # - DELETE  /stress/readonly    -> 405
    location /stress/readonly   {
        methods     GET;
        autoindex   off;
    }

    # ========== CGI TESTS ==========

    location /cgi-bin {
        methods     GET POST;
        autoindex   off;
        root        ./www/cgi-bin;
        cgi_pass    .py /usr/bin/python3;
        # cgi_pass    .sh /bin/sh;
    }

    # ========== STRESS-TEST FOCUSED ENDPOINTS ==========

    location /stress/small  {
        methods     GET;
        autoindex   off;
    }

    location /stress/large  {
        methods     GET;
        autoindex   off;
    }

    location /stress/upload  {
        methods     POST;
        autoindex   off;
    }
}